---
layout: post
title:  "SanghyunPark - About Project (2)"
date:   2022-03-05 10:00:00 -0500
categories: 일기 SanghyunPark
---

### Image Transmission

LoRa로 Image를 보낸다는 것은 여간 쉬운일이 아니다. LoRa는 생각보다 너무 느리다. Payload도 너무 작다.
나는 Image를 250byte씩 Fragmentation을 진행하였고, 순차적으로 전달하는 식으로 구현하였다. (김상하 교수님의 데이터 통신 사랑해요!)

이렇게 하니 data rate이 125bytes/sec 정도로 참담하게 나왔고, 3MB의 이미지를 전송하려면 24000초, 즉 400분이 소요되는 ㅎㅎ.. 재미난 현상을 맞이하였다.

다행히도 여러 논문에서 이미지 전송에 대해 다루었고, 나는 이미지를 할수있는 최대로 압축하기로 하였다.
그결과 원래 이미지를 30KB 정도까지 압축할 수 있었고, 이미지 전송 소요 예상 시간을 4분으로 (무려 100배!) 줄이는데 성공하였다.

그럼에도 너무 느렸다.
그렇지만 일단은 Sound Sensor에 집중하기로 하였다.


### Sound Sensor

총소리를 인식해야 했다. 가장 쉬운 방법인 소리 센서를 이용하기로 했다. 문제점이 있었는데, Raspberry Pi는 Analog Input을 받지 못하였다. Analog-to-Digital가 필요했다. 신기하게도 Grove라는 회사에서 해당 기능을 하는 Hat을 만들어 팔고 있었다. 우리는 그것을 구매하여 사용하였다.

그러나, Sound Sensor는 너무 민감했다. 그리고 최대로 들을 수 있는 수치가 정해져 있었고, 이 수치는 우리가 예상한 수치보다 훨신 낮았다.
쉽게 말하자면 총소리를 인식하기에는 최악이었다.

그래서 우리는 다른 Sound Sensor를 사용하기로 하였다.


LMV324 라는 교수님께서 추천해주신 Sound Sensor를 구입하였다. 나는 죽어도 Arduino는 쓰기 싫었다. 전력소모만 늘기 때문이다.
그래서 LMV324 Sound Sensor를 Sound Detector로 이용하였다. 이 센서는 고맙게도 특정 Threshold를 넘어가는 소리를 들으면 Digital Output을 내보내준다.
나는 그 Digital Output을 Raspberry Pi가 읽도록 하였다.

Threshold는 저항을 연결하여 적절히 정해주었다.
구체적으로는 10K Resistor를 센서에 연결하였다.


### 다시 LoRa..

Sound Detector까지 구현하고 나니 어느정도 Arduino를 없앨만한 여유가 생겼다.
현재 LoRa Shield를 Arduino에 연결하여 사용하고 있었는데, Dragino사의 LoRa Hat을 이용하여 Raspberry Pi만 남겨보기로 하였다.

처음에는 조금 헤맸다. 정말 오랜만에 C 코딩을 해야했기 때문이다. (ㅋㅋ..)

그러나 Raspberry Pi에 직접 연결된 LoRa Hat은 Flow Control의 필요성을 적절히 없애주었다. (아주 없앤건 아니다.)

속도는 대폭 향상되었다. 최대 2KB/sec 의 속도를 내며 기존의 Arduino를 USB로 연결했을 때보다 16배정도 속도향상이 있었다.

30KB의 이미지를 전송하는 데에는 (이론상으로는) 15초가 걸렸다.

대단한 발전이었다.
행복했다.
그러나 우리는 시간에 쫓기고 있었다.
달력은 어느새 2월 중순을 가리키고 있었다.


### 논문에 대한 압박

프로젝트 마감 2주정도가 남았을까, 논문 작성에 대한 압박이 심해졌다.
아직 할게 많은데 논문까지 써야하니 미치는줄 알았다.

그렇게 논문 마감일까지 밤을 새며 미완성된 논문을 제출했다.
나름 열심히 썼는데, 왜 이따구로 썼냐고 욕먹었다 ㅋㅋ
시간이 있으면 분명 더 잘 썼을 것이라 확신한다.


### Bluetooth의 도입

우리는 LoRa를 장거리 통신에 이용하였다. Shot Marker는 AP로 WiFi를 채택하여 Device로 넘겨주었는데, 우리도 넘겨줄 통신 프로토콜이 필요했다.
WiFi는 싫었다. 차별점이 없기도 했고 그냥 싫었다. 지금 생각해보면 가장 쉬운 방법이었기 때문이었던것 같다.

그래서 나는 Bluetooth를 생각했다. 내가 생각할 수 있는 최선이었다고 말하고 싶다.
다른 대안으로 LAN 케이블 등이 있었지만, 시간이 없기도 했고, Bluetooth를 사용하는 것이 종합적으로 좋아보였다.

Raspberry Pi에서 Device로 이미지를 손쉽게 보내는데 이용하였다.
뿐만 아니라, Device에서 Signal을 보내고, Raspberry Pi에서 받아 쓸 수 있도록 하였다.


### Bash Script

이전에 이성호 교수님께서 Bash Script를 알아두면 좋다고 하셨었다.
그러나 그 말씀을 들었을 때에는 도저히 어디에 쓸일이 있는지 알 수 없었다.
그때 공부좀 해둘걸.

Raspberry Pi 2개와 Android 간의 통신과 모든 작업을 Bash Script로 자동화를 해야했다.
겁나 힘들었다.
처음 짜보다 보니 잔실수도 많았고, 시간도 오래걸렸다.
덕분에 팀원들이 나를 기다리느라 고생만했다 ㅎㅎ..

그래도 결국 Demo 전날까지 모두 짜냈다. 기다려준 팀원들에게 너무 고마웠다.


### Demo

우리가 만든 IoT System을 실제로 테스팅해보고 실험해보고 싶었다.
실내에서는 정말 잘 돌아갔다.
실외에서도 잘 돌아갈 줄 알았다.

LoRa는 참 변덕이 심했다. 왜인지 밖에서는 엉뚱하게 작동하였고, 몇 번의 코드 수정을 거치고 나서야 겨우 데모를 찍을 수 있었다.


### 추후

시간이 된다면 발표 관련이나 미국 생활 등에 대한 일기도 쓰고 싶다.
